-- ========================================
-- VERIFICACI√ìN FINAL DE LOS 18 TRIGGERS
-- ========================================

PROMPT 'üèÜ === VERIFICACI√ìN FINAL DE LOS 18 TRIGGERS ==='
PROMPT ''

-- Lista completa de los 18 triggers esperados
PROMPT 'üìã LISTA COMPLETA DE TRIGGERS:'

WITH triggers_esperados AS (
    SELECT 'TRG_PRODUCTOS_CALCULOS' as trigger_name, '1Ô∏è‚É£ C√ÅLCULOS' as grupo FROM dual UNION ALL
    SELECT 'TRG_STOCK_CONTROL', '1Ô∏è‚É£ C√ÅLCULOS' FROM dual UNION ALL
    SELECT 'TRG_ALERTAS_CADUCIDAD', '1Ô∏è‚É£ C√ÅLCULOS' FROM dual UNION ALL
    SELECT 'TRG_CONTROL_CAJA', '1Ô∏è‚É£ C√ÅLCULOS' FROM dual UNION ALL
    SELECT 'TRG_AUDITORIA_PRODUCTOS', '2Ô∏è‚É£ AUDITOR√çA' FROM dual UNION ALL
    SELECT 'TRG_AUDITORIA_VENTAS', '2Ô∏è‚É£ AUDITOR√çA' FROM dual UNION ALL
    SELECT 'TRG_AUDITORIA_USUARIOS', '2Ô∏è‚É£ AUDITOR√çA' FROM dual UNION ALL
    SELECT 'TRG_NOTIFICACIONES_STOCK', '3Ô∏è‚É£ NOTIFICACIONES' FROM dual UNION ALL
    SELECT 'TRG_NOTIFICACIONES_CADUCIDAD', '3Ô∏è‚É£ NOTIFICACIONES' FROM dual UNION ALL
    SELECT 'TRG_NOTIFICACIONES_VENTAS', '3Ô∏è‚É£ NOTIFICACIONES' FROM dual UNION ALL
    SELECT 'TRG_NOTIFICACIONES_SISTEMA', '3Ô∏è‚É£ NOTIFICACIONES' FROM dual UNION ALL
    SELECT 'TRG_CALCULOS_VENTAS', '4Ô∏è‚É£ VENTAS' FROM dual UNION ALL
    SELECT 'TRG_CALCULOS_DETALLE_VENTAS', '4Ô∏è‚É£ VENTAS' FROM dual UNION ALL
    SELECT 'TRG_ACTUALIZAR_TOTALES_VENTA', '4Ô∏è‚É£ VENTAS' FROM dual UNION ALL
    SELECT 'TRG_CONTROL_DEVOLUCIONES', '4Ô∏è‚É£ VENTAS' FROM dual UNION ALL
    SELECT 'TRG_APLICACION_PROMOCIONES', '5Ô∏è‚É£ PROMOCIONES' FROM dual UNION ALL
    SELECT 'TRG_CONTROL_COMBOS', '5Ô∏è‚É£ PROMOCIONES' FROM dual UNION ALL
    SELECT 'TRG_GENERACION_REPORTES', '6Ô∏è‚É£ REPORTES' FROM dual UNION ALL
    SELECT 'TRG_CONTROL_SESIONES', '6Ô∏è‚É£ REPORTES' FROM dual
)
SELECT 
    te.grupo as "GRUPO",
    te.trigger_name as "TRIGGER",
    NVL(ut.status, '‚ùå NO EXISTE') as "ESTADO",
    CASE 
        WHEN ut.status = 'ENABLED' THEN '‚úÖ'
        WHEN ut.status IS NOT NULL THEN '‚ö†Ô∏è'
        ELSE '‚ùå'
    END as "OK"
FROM triggers_esperados te
LEFT JOIN user_triggers ut ON te.trigger_name = ut.trigger_name
ORDER BY te.grupo, te.trigger_name;

PROMPT ''
PROMPT 'üìä RESUMEN POR GRUPOS:'

WITH triggers_esperados AS (
    SELECT 'TRG_PRODUCTOS_CALCULOS' as trigger_name, '1Ô∏è‚É£ C√ÅLCULOS' as grupo FROM dual UNION ALL
    SELECT 'TRG_STOCK_CONTROL', '1Ô∏è‚É£ C√ÅLCULOS' FROM dual UNION ALL
    SELECT 'TRG_ALERTAS_CADUCIDAD', '1Ô∏è‚É£ C√ÅLCULOS' FROM dual UNION ALL
    SELECT 'TRG_CONTROL_CAJA', '1Ô∏è‚É£ C√ÅLCULOS' FROM dual UNION ALL
    SELECT 'TRG_AUDITORIA_PRODUCTOS', '2Ô∏è‚É£ AUDITOR√çA' FROM dual UNION ALL
    SELECT 'TRG_AUDITORIA_VENTAS', '2Ô∏è‚É£ AUDITOR√çA' FROM dual UNION ALL
    SELECT 'TRG_AUDITORIA_USUARIOS', '2Ô∏è‚É£ AUDITOR√çA' FROM dual UNION ALL
    SELECT 'TRG_NOTIFICACIONES_STOCK', '3Ô∏è‚É£ NOTIFICACIONES' FROM dual UNION ALL
    SELECT 'TRG_NOTIFICACIONES_CADUCIDAD', '3Ô∏è‚É£ NOTIFICACIONES' FROM dual UNION ALL
    SELECT 'TRG_NOTIFICACIONES_VENTAS', '3Ô∏è‚É£ NOTIFICACIONES' FROM dual UNION ALL
    SELECT 'TRG_NOTIFICACIONES_SISTEMA', '3Ô∏è‚É£ NOTIFICACIONES' FROM dual UNION ALL
    SELECT 'TRG_CALCULOS_VENTAS', '4Ô∏è‚É£ VENTAS' FROM dual UNION ALL
    SELECT 'TRG_CALCULOS_DETALLE_VENTAS', '4Ô∏è‚É£ VENTAS' FROM dual UNION ALL
    SELECT 'TRG_ACTUALIZAR_TOTALES_VENTA', '4Ô∏è‚É£ VENTAS' FROM dual UNION ALL
    SELECT 'TRG_CONTROL_DEVOLUCIONES', '4Ô∏è‚É£ VENTAS' FROM dual UNION ALL
    SELECT 'TRG_APLICACION_PROMOCIONES', '5Ô∏è‚É£ PROMOCIONES' FROM dual UNION ALL
    SELECT 'TRG_CONTROL_COMBOS', '5Ô∏è‚É£ PROMOCIONES' FROM dual UNION ALL
    SELECT 'TRG_GENERACION_REPORTES', '6Ô∏è‚É£ REPORTES' FROM dual UNION ALL
    SELECT 'TRG_CONTROL_SESIONES', '6Ô∏è‚É£ REPORTES' FROM dual
)
SELECT 
    te.grupo as "GRUPO",
    COUNT(*) as "ESPERADOS",
    COUNT(CASE WHEN ut.status = 'ENABLED' THEN 1 END) as "‚úÖ FUNCIONANDO",
    COUNT(CASE WHEN ut.status IS NULL THEN 1 END) as "‚ùå FALTANTES",
    ROUND(COUNT(CASE WHEN ut.status = 'ENABLED' THEN 1 END) * 100.0 / COUNT(*), 1) as "% √âXITO"
FROM triggers_esperados te
LEFT JOIN user_triggers ut ON te.trigger_name = ut.trigger_name
GROUP BY te.grupo
ORDER BY te.grupo;

PROMPT ''
PROMPT 'üéØ ESTAD√çSTICAS FINALES:'

WITH triggers_esperados AS (
    SELECT 'TRG_PRODUCTOS_CALCULOS' as trigger_name FROM dual UNION ALL
    SELECT 'TRG_STOCK_CONTROL' FROM dual UNION ALL
    SELECT 'TRG_ALERTAS_CADUCIDAD' FROM dual UNION ALL
    SELECT 'TRG_CONTROL_CAJA' FROM dual UNION ALL
    SELECT 'TRG_AUDITORIA_PRODUCTOS' FROM dual UNION ALL
    SELECT 'TRG_AUDITORIA_VENTAS' FROM dual UNION ALL
    SELECT 'TRG_AUDITORIA_USUARIOS' FROM dual UNION ALL
    SELECT 'TRG_NOTIFICACIONES_STOCK' FROM dual UNION ALL
    SELECT 'TRG_NOTIFICACIONES_CADUCIDAD' FROM dual UNION ALL
    SELECT 'TRG_NOTIFICACIONES_VENTAS' FROM dual UNION ALL
    SELECT 'TRG_NOTIFICACIONES_SISTEMA' FROM dual UNION ALL
    SELECT 'TRG_CALCULOS_VENTAS' FROM dual UNION ALL
    SELECT 'TRG_CALCULOS_DETALLE_VENTAS' FROM dual UNION ALL
    SELECT 'TRG_ACTUALIZAR_TOTALES_VENTA' FROM dual UNION ALL
    SELECT 'TRG_CONTROL_DEVOLUCIONES' FROM dual UNION ALL
    SELECT 'TRG_APLICACION_PROMOCIONES' FROM dual UNION ALL
    SELECT 'TRG_CONTROL_COMBOS' FROM dual UNION ALL
    SELECT 'TRG_GENERACION_REPORTES' FROM dual UNION ALL
    SELECT 'TRG_CONTROL_SESIONES' FROM dual
)
SELECT 
    18 as "üéØ TRIGGERS_ESPERADOS",
    COUNT(CASE WHEN ut.status = 'ENABLED' THEN 1 END) as "‚úÖ FUNCIONANDO",
    COUNT(CASE WHEN ut.status IS NULL THEN 1 END) as "‚ùå FALTANTES",
    COUNT(CASE WHEN ut.status != 'ENABLED' AND ut.status IS NOT NULL THEN 1 END) as "‚ö†Ô∏è CON_ERRORES",
    ROUND(COUNT(CASE WHEN ut.status = 'ENABLED' THEN 1 END) * 100.0 / 18, 1) as "üìä % COMPLETADO"
FROM triggers_esperados te
LEFT JOIN user_triggers ut ON te.trigger_name = ut.trigger_name;

PROMPT ''
PROMPT 'üèÜüèÜüèÜ === SISTEMA LA MODERNA ==='
PROMPT 'üéâ ¬°VERIFICACI√ìN COMPLETA FINALIZADA!'
PROMPT ''
